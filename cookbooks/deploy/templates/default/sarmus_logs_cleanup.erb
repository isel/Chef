#!/usr/bin/env ruby
require 'date'

SARMUS_LOG = '/mnt/test/logs/sarmus.log'
SARMUS_DAYS_TO_KEEP_LOGS = <%= @sarmus_days_to_keep_logs %>

Dir.chdir(File.dirname(SARMUS_LOG))

file_list = Dir.glob(File.basename(SARMUS_LOG) + '.*' )

file_list.delete_if do
  |file_name| file_name =~ /\.gz$/
end

dnow = Time.now
dlatest = Date.new(dnow.year, dnow.month, dnow.mday )

((dlatest - SARMUS_DAYS_TO_KEEP_LOGS )..(dlatest)).each do
  |date_stamp|
  file_list.delete_if do
    |file_name|
    file_name.match(Regexp.new(date_stamp.to_s.gsub(/-/,'\-')))
  end
end

if file_list.empty?
 puts 'Nothing to archive'
else
 puts "Archive #{file_list.join(',')}"
 res = %x(/bin/gzip -9 -f #{file_list.join(' ')})
end

