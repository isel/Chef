require 'rake'
require 'fileutils'
require 'json'

require '<%= @binaries_directory %>/CI/BuildScripts/Helpers/configuration'
require '<%= @binaries_directory %>/CI/BuildScripts/Helpers/io_utils'

settings = JSON.parse(File.read('<%= node['deployment_settings_json'] %>'))

source_directory = '<%= @source_directory %>'
target_directory = '<%= @target_directory %>'
messaging_server = '<%= @messaging_server %>'
messaging_port = settings['messaging_port']
db_server = '<%= @db_server %>'

app_config = "#{target_directory}/UltimateSoftware.Foundation.Messaging.EventRouter.exe.config"

if File.exist?(target_directory)
  puts 'Event Router Service has already been configured'
else
  FileUtils.mkdir_p(target_directory)
  FileUtils.cp_r("#{source_directory}/.",  target_directory )
end

Helpers::change_app_setting(app_config, "MessagingServer.Uri", "http://#{messaging_server}:#{messaging_port}")
Helpers::change_app_setting(app_config, "ConnectionString", "Server=#{db_server}:#{settings['database_port']}")

IOUtils::replace_text_in_file(app_config, '<%= '<host name="localhost"' %>', "<%= '<host name=\"' %><%= @cache_server %>\"")
IOUtils::replace_text_in_file(app_config, '<\/hosts>', '</hosts><securityProperties mode="None" protectionLevel="None"/>')
