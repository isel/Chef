require 'rake'
require 'json'

require '<%= node['binaries_directory'] %>/CI/BuildScripts/Deployment/provision'

settings = JSON.parse(File.read('<%= node['ruby_scripts_dir'] %>/deployment_settings.txt'))

config = '/Provision/bin/UltimateSoftware.Provisioning.Runner.exe.config'

puts 'Provisioning deployment'

provision = Deployment::Provision.new(
  '<%= node['binaries_directory'] %>', '/Provision',
  '<%= node['pims_directory'] %>', '/PIM_Publishing')

provision.update_settings(config, '<%= @db_server %>', settings['database_port'])