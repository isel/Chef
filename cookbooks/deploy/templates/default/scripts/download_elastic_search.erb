require 'fog'
require 'fileutils'

install_dir = '<%= @install_dir %>'
version = '<%= @version %>'
puts "downloading elastic search version: #{version} to #{install_dir}"

storage = Fog::Storage.new(
  :provider => 'AWS',
  :aws_access_key_id => '<%= @aws_access_key_id %>',
  :aws_secret_access_key => '<%= @aws_secret_access_key %>'
)

bucket = storage.directories.find { |d| d.key == 'ugfinfrastructure' }
s3_files = bucket.files

if s3_files.get("ElasticSeach/#{version}/")
  install_files = ['elasticsearch', 'servicewrapper']

  deploy_folder = '/opt/ElasticSearch/'
  Dir.mkdir(deploy_folder)
  Dir.chdir(deploy_folder)

  install_files.each do |f|
    file = s3_files.get("ElasticSeach/#{version}/#{f}.tar.gz")
    File.open("#{deploy_folder}/#{f}.tar.gz", 'wb') do |local_file|
      local_file.write(file.body)
    end
    `tar xvf #{f}.tar.gz`
  end

  `ln -s elasticsearch current`
  `rm elasticsearch.tar.gz`

  `mv servicewrapper/service current/bin/`
  `rm -Rf servicewrapper`
  `rm servicewrapper.tar.gz`
else
  puts "cannot find version #{version} in S3..."
end