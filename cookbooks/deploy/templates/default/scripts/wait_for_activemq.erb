require 'json'

settings = JSON.parse(File.read('<%= node['ruby_scripts_dir'] %>/deployment_settings.txt'))

sleep_time = 5
done = false
elapsed = 0
until done || elapsed >= 300
  sleep sleep_time
  result = `netstat -an | grep :#{settings['activemq_port']}`
  done = !result.empty?
  elapsed += sleep_time
end

raise "timeout waiting for actimemq" unless done