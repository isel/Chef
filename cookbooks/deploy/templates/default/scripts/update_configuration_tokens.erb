# find and replace tokens in mule properties file

require 'fileutils'
require 'json'
require 'yaml'

$DEBUG = false

settings = JSON.parse(File.read('<%= node['deployment_settings_json'] %>'))

mule_configuration_dir='/opt/mule/configuration'
properties_filename = "#{mule_configuration_dir}/ultimate.properties"
properties_backup_filename = "#{properties_filename}.BAK"

# using tokens instead of variable reference as hash keys
token_values = {
  'app_server' => '<%= @app_server %>',
  'cache_server' => '<%= @cache_server %>',
  'db_port' => settings['database_port'],
  'db_server' => '<%= @db_server %>',
  'engine_port' => settings['engine_port'],
  'engine_server' => '<%= @engine_server %>',
  'messaging_port' => settings['messaging_port'],
  'messaging_server' => '<%= @messaging_server %>',
  'search_port' => settings['search_port'],
  'search_server' => '<%= @search_server %>',
  'tenant_id' => '<%= @tenant %>',
  'web_server' => '<%= @web_server %>'
}

def update_properties(source_file, target_file, token_values)
  contents = ''
  File.open(source_file, 'r+') { |f| contents = f.read }
  token_values.each do |token, entry|
    matcher = Regexp.new('(\{' + token + '\})', Regexp::MULTILINE)
    while matcher.match(contents) # multiline ?
      $stderr.puts "Will replace #{matcher.source} with #{entry}"
      contents=contents.gsub(matcher, entry)
    end
  end
  File.open(target_file, 'w') { |f| f.puts contents }
end

# replace tokens in mule properties file
if File.exists?(mule_configuration_dir)

  if !File.exists?(properties_backup_filename)
    FileUtils.cp(properties_filename, properties_backup_filename)
    $stderr.puts  "properties file backed up"
  else
    $stderr.puts  "backup already exists: #{properties_backup_filename}"
  end
  update_properties(properties_backup_filename, properties_filename, token_values)
  $stderr.puts  "Properties updated"
else
  $stderr.puts  "Directory does not exist #{mule_configuration_dir}"
end