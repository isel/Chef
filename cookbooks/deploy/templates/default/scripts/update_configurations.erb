require 'rake'
require '/DeployScripts/CI/BuildScripts/Helpers/configuration'
require '/DeployScripts/CI/BuildScripts/Helpers/io_utils'

configs = FileList['/Websites/**/*.config']
puts "found #{configs.count} config files"

def thumbprint
   `powershell -Command "((dir cert:\\localmachine\\Root -rec | where-object {$_.Subject -eq 'CN=localhost'}) | select-object thumbprint).thumbprint"`.strip
end

IOUtils::replace_text_in_files(configs, 'F0C92080457571AAA70CE209C8CDFABCD38F87CC', thumbprint)

Helpers::change_all_app_settings(configs, "SigningCertificateName", "CN=localhost")
Helpers::change_all_app_settings(configs, "ConnectionString", "Server=<%= @db_server %>:<%= @sarmus_port %>")
Helpers::change_all_app_settings(configs, "SearchUri", "http://<%= @db_server %>:<%= @elastic_search_port %>/ugf/viabot/_search")
Helpers::change_all_app_settings(configs, "EntityFramework.ModelFolder", "C:\\WebSites\\Models\\")

IOUtils::replace_text_in_files(configs, '<%= '<host name="localhost"' %>', "<%= '<host name=\"' %><%= @cache_server %>\"")
IOUtils::replace_text_in_files(configs, '<\/hosts>', '</hosts><securityProperties mode="None" protectionLevel="None"/>')

active_sts = '/Websites/ActiveSTS/configuration/ActiveSTS.config'
IOUtils::replace_text_in_file(active_sts, /localhost:2702/, 'localhost:81')
IOUtils::replace_text_in_file(active_sts, /:81\/sts/, ':81/')

file = '/Websites/UltimateSoftware.Help.Services/Web.config'
type = "UltimateSoftware.Foundation.IdentityModel.Contracts.WebRequests.USWebRequestDevAuthorizationManager, UltimateSoftware.Foundation.IdentityModel.Contracts"
puts "changing service authorization to type=#{type} in file=#{file}"
xs = XmlSimple.new({
  RootName: 'configuration',
  XmlDeclaration: "<?xml version=\"1.0\" encoding=\"utf-8\" ?>"
})
#ref = xs.xml_in(file)
#logging = ref["system.serviceModel"][0]["behaviors"][0]["serviceBehaviors"][0]["behavior"][0]["serviceAuthorization"]
#logging[0]["serviceAuthorizationManagerType"] = type
#File.open(file, 'w+') { |file| file.puts xs.xml_out(ref) }

