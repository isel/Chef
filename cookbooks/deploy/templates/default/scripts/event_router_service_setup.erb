require 'fileutils'
require '<%= node['binaries_directory'] %>/CI/BuildScripts/Helpers/configuration'


source_directory = '<%= @source_directory %>'
target_directory = '<%= @target_directory %>'
messaging_server = '<%= @messaging_server %>'
messaging_server_port = '<%= @messaging_server_port %>'
app_config       = 'UltimateSoftware.Foundation.Messaging.EventRouter.exe.config'

if Dir.exist?(target_directory)
puts 'Event Roures Service has already been configured'
exit 0
end

if !Dir.exist?(source_directory)
puts 'Event Roures Service source directory is missing'
exit  4
end

FileUtils.mkdir_p(target_directory)
if !Dir.exist?(target_directory)
puts 'Event Roures Service target directory cannot be created'
exit 8
end

puts "Copying application files #{source_directory} to #{target_directory}"

Dir.chdir(source_directory)

FileUtils.cp_r("#{source_directory}/.",  target_directory )

Dir.chdir(target_directory)


if !File.exist?(app_config)
puts 'Event Roures Service configuration file #{app_config} is missing'
exit  16
end

puts "Updating configuration file #{app_config} with #{messaging_server}"
Helpers::change_app_setting(app_config, "MessagingServer.Uri", "http://#{messaging_server}:#{messaging_server_port}")
